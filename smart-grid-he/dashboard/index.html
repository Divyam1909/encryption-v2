<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privacy-Preserving Smart Grid</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>üîí Privacy-Preserving Smart Grid</h1>
            <p class="subtitle">Homomorphic Encryption for Load Balancing</p>
        </header>

        <!-- Configuration Panel -->
        <div class="panel config-panel">
            <h2>‚öôÔ∏è System Configuration</h2>
            <div class="config-grid">
                <div class="config-item">
                    <label>
                        Number of Households
                        <span class="hint-icon"
                            data-tooltip="Number of smart meter agents in the simulation. Each household encrypts its consumption data independently before sending to the coordinator.">?</span>
                    </label>
                    <input type="number" id="config-agents" value="25" min="5" max="100">
                </div>
                <div class="config-item">
                    <label>
                        Grid Capacity (kW)
                        <span class="hint-icon"
                            data-tooltip="Maximum power capacity of the grid. Load balancing actions are triggered when total demand exceeds 80% of this value.">?</span>
                    </label>
                    <input type="number" id="config-capacity" value="100" min="50" max="500" step="10">
                </div>
                <div class="config-item">
                    <label>
                        Demand Range (kW)
                        <span class="hint-icon"
                            data-tooltip="Min and max electricity demand per household. Values are randomly generated within this range using realistic load profiles (residential, commercial, industrial).">?</span>
                    </label>
                    <div class="range-inputs">
                        <input type="number" id="config-demand-min" value="1" min="0" max="10" step="0.5">
                        <span>to</span>
                        <input type="number" id="config-demand-max" value="8" min="1" max="20" step="0.5">
                    </div>
                </div>
                <div class="config-item">
                    <button id="apply-config-btn" class="btn btn-secondary">Apply Configuration</button>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <span class="label">Status:</span>
                <span id="system-status" class="value status-online">‚óè Online</span>
            </div>
            <div class="status-item">
                <span class="label">Agents:</span>
                <span id="agent-count" class="value">--</span>
            </div>
            <div class="status-item">
                <span class="label">Rounds:</span>
                <span id="round-count" class="value">0</span>
            </div>
            <div class="status-item">
                <span class="label">Privacy:</span>
                <span id="privacy-status" class="value status-secure">‚úì Preserved</span>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button id="run-round-btn" class="btn btn-primary">‚ñ∂ Run Round</button>
            <button id="auto-start-btn" class="btn btn-secondary">‚ü≥ Auto (3s)</button>
            <button id="auto-stop-btn" class="btn btn-danger" style="display:none;">‚èπ Stop</button>
            <button id="reset-btn" class="btn btn-secondary">‚Ü∫ Reset</button>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="topology">üè† Grid Topology</button>
            <button class="tab-btn" data-tab="graphs">üìä Analytics</button>
            <button class="tab-btn" data-tab="system">üîê System Info</button>
        </div>

        <!-- Tab Content: Grid Topology -->
        <div id="topology-tab" class="tab-content active">
            <!-- Grid Topology Visualization -->
            <div class="panel topology-panel">
                <h2>üèòÔ∏è Smart Grid Topology</h2>
                <div class="topology-container">
                    <svg id="grid-topology" viewBox="0 0 800 600" class="topology-svg">
                        <defs>
                            <radialGradient id="coord-glow" cx="50%" cy="50%" r="50%">
                                <stop offset="0%" stop-color="rgba(78, 204, 163, 0.5)" />
                                <stop offset="100%" stop-color="rgba(78, 204, 163, 0)" />
                            </radialGradient>
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="4" result="coloredBlur" />
                                <feMerge>
                                    <feMergeNode in="coloredBlur" />
                                    <feMergeNode in="SourceGraphic" />
                                </feMerge>
                            </filter>
                            <linearGradient id="line-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="#4ecca3" stop-opacity="0.3" />
                                <stop offset="100%" stop-color="#4ecca3" stop-opacity="0.8" />
                            </linearGradient>
                        </defs>

                        <!-- Connection lines -->
                        <g id="connection-lines"></g>

                        <!-- Data packets -->
                        <g id="data-packets"></g>

                        <!-- Central Coordinator -->
                        <g id="coordinator-node" transform="translate(400, 280)">
                            <circle r="80" fill="url(#coord-glow)" />
                            <polygon points="0,-55 48,-27.5 48,27.5 0,55 -48,27.5 -48,-27.5" fill="#161b22"
                                stroke="#4ecca3" stroke-width="3" filter="url(#glow)" />
                            <text y="-8" text-anchor="middle" fill="#4ecca3" font-size="13"
                                font-weight="600">COORDINATOR</text>
                            <text y="8" text-anchor="middle" fill="#f0a500" font-size="10">üîí No Secret Key</text>
                            <text y="24" text-anchor="middle" fill="#8b949e" font-size="9" id="coord-ops">Ops: 0</text>
                        </g>

                        <!-- Utility Company -->
                        <g id="utility-node" transform="translate(400, 520)">
                            <rect x="-70" y="-30" width="140" height="60" rx="10" fill="#161b22" stroke="#58a6ff"
                                stroke-width="2" />
                            <text y="-5" text-anchor="middle" fill="#58a6ff" font-size="12" font-weight="600">‚ö° UTILITY
                                COMPANY</text>
                            <text y="12" text-anchor="middle" fill="#4ecca3" font-size="10">üîë Has Secret Key</text>
                        </g>

                        <!-- Aggregate flow -->
                        <g id="aggregate-flow">
                            <line x1="400" y1="335" x2="400" y2="490" stroke="#58a6ff" stroke-width="2"
                                stroke-dasharray="6,4">
                                <animate attributeName="stroke-dashoffset" from="20" to="0" dur="1s"
                                    repeatCount="indefinite" />
                            </line>
                            <text x="420" y="420" fill="#58a6ff" font-size="10" font-style="italic">E(Œ£d·µ¢) ‚Üí
                                Decrypt</text>
                        </g>

                        <!-- Houses -->
                        <g id="house-nodes"></g>
                    </svg>
                </div>
                <div class="topology-legend">
                    <span><span class="legend-dot house"></span> Household (Unique Encryption)</span>
                    <span><span class="legend-dot coord"></span> Coordinator (Public Key Only)</span>
                    <span><span class="legend-dot utility"></span> Utility (Secret Key Holder)</span>
                </div>
            </div>

            <!-- Aggregate Results with Hint -->
            <div class="main-grid">
                <div class="panel">
                    <h2>
                        üìä Aggregate Results
                        <span class="hint-icon large"
                            data-tooltip="These values are computed homomorphically on encrypted data. The coordinator never sees individual consumption - only the utility company can decrypt the final aggregates using its secret key.">?</span>
                    </h2>
                    <div class="info-box hint-box">
                        <strong>How it works:</strong> Each household encrypts demand E(d·µ¢). Coordinator computes E(Œ£d·µ¢)
                        = E(d‚ÇÅ) ‚äï E(d‚ÇÇ) ‚äï ... without decryption.
                        Utility decrypts only the aggregate, never individual values.
                    </div>
                    <div class="results-grid">
                        <div class="result-card">
                            <span class="result-label">
                                Total Demand
                                <span class="hint-icon small"
                                    data-tooltip="Sum of all encrypted household demands, decrypted by utility. Formula: Œ£d·µ¢ for i=1 to N households.">?</span>
                            </span>
                            <span id="total-demand" class="result-value">-- kW</span>
                        </div>
                        <div class="result-card">
                            <span class="result-label">
                                Average Demand
                                <span class="hint-icon small"
                                    data-tooltip="Total demand divided by number of households. Computed as: E(Œ£d·µ¢) √ó (1/N) homomorphically.">?</span>
                            </span>
                            <span id="avg-demand" class="result-value">-- kW</span>
                        </div>
                        <div class="result-card">
                            <span class="result-label">
                                Grid Utilization
                                <span class="hint-icon small"
                                    data-tooltip="Percentage of grid capacity being used. Formula: (Total Demand / Grid Capacity) √ó 100%. Above 80% triggers load balancing.">?</span>
                            </span>
                            <span id="utilization" class="result-value">-- %</span>
                            <div id="util-bar" class="util-bar">
                                <div class="util-fill"></div>
                            </div>
                        </div>
                        <div class="result-card">
                            <span class="result-label">
                                Load Balance Action
                                <span class="hint-icon small"
                                    data-tooltip="Action taken based on utilization: NONE (<80%), REDUCE_10% (80-90%), REDUCE_20% (90-100%), CRITICAL (>100%).">?</span>
                            </span>
                            <span id="lb-action" class="result-value action-none">--</span>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h2>
                        üîê Per-Household Encrypted Data
                        <span class="hint-icon large"
                            data-tooltip="Each household has a UNIQUE ciphertext because CKKS encryption uses random noise. Even identical plaintext values produce different ciphertexts, providing semantic security.">?</span>
                    </h2>
                    <div class="info-box hint-box">
                        <strong>Why different ciphertexts?</strong> CKKS uses randomized encryption. Each E(d·µ¢) includes
                        unique random noise,
                        so even identical demands produce different ciphertexts. This prevents pattern analysis.
                    </div>
                    <div id="encrypted-flow" class="encrypted-flow">
                        <div class="flow-item placeholder">
                            <span class="agent-icon">üè†</span>
                            <span class="arrow">‚Üí</span>
                            <span class="ciphertext">Run a round to see encrypted data per household...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Analytics/Graphs -->
        <div id="graphs-tab" class="tab-content">
            <!-- Comparison Charts -->
            <div class="panel chart-panel">
                <h2>
                    üìà Encrypted vs Plaintext Comparison
                    <span class="hint-icon large"
                        data-tooltip="This chart proves FHE correctness: decrypted encrypted computation matches direct plaintext computation. The error is ~10‚Åª‚Å∑, negligible for power grid applications.">?</span>
                </h2>
                <p class="note">CKKS scheme maintains ~10‚Åª‚Å∑ relative error, negligible for practical use. Both lines
                    should overlap almost perfectly.</p>
                <div class="chart-container">
                    <canvas id="comparison-chart"></canvas>
                </div>
            </div>

            <div class="charts-grid">
                <div class="panel chart-panel">
                    <h2>‚ö° Grid Utilization Over Time</h2>
                    <div class="chart-container-medium">
                        <canvas id="utilization-chart"></canvas>
                    </div>
                </div>
                <div class="panel chart-panel">
                    <h2>‚è±Ô∏è FHE Computation Time</h2>
                    <div class="chart-container-medium">
                        <canvas id="time-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Error Chart -->
            <div class="panel chart-panel">
                <h2>üéØ Encryption Error Analysis</h2>
                <p class="note">Shows the absolute difference between encrypted and plaintext computations. Lower is
                    better.</p>
                <div class="chart-container-small">
                    <canvas id="error-chart"></canvas>
                </div>
            </div>

            <!-- Accuracy Metrics -->
            <div class="panel comparison-panel">
                <h2>‚öñÔ∏è Latest Round Accuracy</h2>
                <div class="comparison-grid">
                    <div class="comparison-card">
                        <span class="comparison-label">Encrypted Total</span>
                        <span id="enc-total" class="comparison-value">-- kW</span>
                    </div>
                    <div class="comparison-card">
                        <span class="comparison-label">Plaintext Total</span>
                        <span id="plain-total" class="comparison-value">-- kW</span>
                    </div>
                    <div class="comparison-card highlight">
                        <span class="comparison-label">Absolute Error</span>
                        <span id="error" class="comparison-value">-- kW</span>
                    </div>
                    <div class="comparison-card">
                        <span class="comparison-label">Computation Time</span>
                        <span id="comp-time" class="comparison-value">-- ms</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: System Info -->
        <div id="system-tab" class="tab-content">
            <!-- Encryption Details -->
            <div class="panel info-panel">
                <h2>üîê Homomorphic Encryption Details</h2>
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-icon">üõ°Ô∏è</div>
                        <div class="info-content">
                            <h3>CKKS Scheme</h3>
                            <p>Cheon-Kim-Kim-Song scheme for approximate arithmetic on encrypted real numbers.</p>
                            <div class="tech-specs">
                                <span><strong>Library:</strong> TenSEAL</span>
                                <span><strong>Security:</strong> 128-bit</span>
                            </div>
                        </div>
                    </div>
                    <div class="info-card">
                        <div class="info-icon">üî¢</div>
                        <div class="info-content">
                            <h3>Cryptographic Parameters</h3>
                            <p>Optimized for smart grid aggregation with sufficient depth for operations.</p>
                            <div class="tech-specs">
                                <span><strong>Poly Degree:</strong> 16384</span>
                                <span><strong>Scale:</strong> 2‚Å¥‚Å∞</span>
                                <span><strong>Precision:</strong> ~12 digits</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Novel Contributions - Expandable -->
            <div class="panel info-panel">
                <h2>‚≠ê Novel Research Contributions</h2>
                <p class="note">Click each contribution to expand and learn more.</p>

                <div class="expandable-card" id="contrib-1">
                    <div class="expandable-header" onclick="toggleExpand('contrib-1')">
                        <div class="expand-icon">‚ñ∂</div>
                        <div class="expand-title">
                            <span class="expand-number">1</span>
                            <h3>Encrypted Threshold Detection via Linear Approximation</h3>
                        </div>
                    </div>
                    <div class="expandable-content">
                        <div class="contribution-detail">
                            <h4>ü§î The Problem</h4>
                            <p>Homomorphic encryption lets you compute on encrypted data, but it <strong>cannot compare
                                    values</strong>.
                                For example, you can't directly check "is the encrypted demand greater than 80%
                                capacity?" without decrypting first.</p>

                            <h4>üí° Our Solution</h4>
                            <p>We use a <strong>linear approximation</strong> instead of trying to compute exact
                                comparisons:</p>
                            <code class="formula">score(x) = 0.5 + (x - Threshold) √ó (0.5 / Œ¥)</code>

                            <h4>üìä How It Works</h4>
                            <ul>
                                <li><strong>Score near 0:</strong> Value is clearly BELOW the threshold</li>
                                <li><strong>Score near 0.5:</strong> Value is NEAR the threshold (uncertain zone)</li>
                                <li><strong>Score near 1:</strong> Value is clearly ABOVE the threshold</li>
                            </ul>

                            <h4>‚úÖ Why This Is Novel</h4>
                            <ul>
                                <li>Uses only addition and scalar multiplication (no expensive ciphertext√óciphertext)
                                </li>
                                <li>Works within CKKS noise budget (depth 1 operation)</li>
                                <li>Provides confidence levels, not just binary yes/no</li>
                                <li>First practical comparison method for encrypted smart grid data</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="expandable-card" id="contrib-2">
                    <div class="expandable-header" onclick="toggleExpand('contrib-2')">
                        <div class="expand-icon">‚ñ∂</div>
                        <div class="expand-title">
                            <span class="expand-number">2</span>
                            <h3>Commitment-Based Verifiable Aggregation</h3>
                        </div>
                    </div>
                    <div class="expandable-content">
                        <div class="contribution-detail">
                            <h4>ü§î The Problem</h4>
                            <p>How can the utility company <strong>verify</strong> that the coordinator computed the
                                aggregate correctly?
                                A malicious coordinator could manipulate the encrypted sum, and no one would know.</p>

                            <h4>üí° Our Solution</h4>
                            <p>Each household sends a <strong>Pedersen commitment</strong> alongside their encrypted
                                data:</p>
                            <code class="formula">Commit(value) = g^value √ó h^randomness</code>

                            <h4>üìä How It Works</h4>
                            <ul>
                                <li>Households send both E(d·µ¢) and Commit(d·µ¢)</li>
                                <li>Commitments are <strong>additively homomorphic</strong>: Commit(a) √ó Commit(b) =
                                    Commit(a+b)</li>
                                <li>Coordinator multiplies all commitments together</li>
                                <li>Utility verifies: decrypted sum matches the aggregate commitment</li>
                            </ul>

                            <h4>‚úÖ Why This Is Novel</h4>
                            <ul>
                                <li>Detects any coordinator manipulation with probability 1</li>
                                <li>Commitments are computationally hiding (reveal nothing about values)</li>
                                <li>First integration of Pedersen commitments with CKKS for smart grids</li>
                                <li>Minimal overhead (~1% additional computation)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Architecture -->
            <div class="panel info-panel">
                <h2>üèóÔ∏è Security Model</h2>
                <div class="security-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Entity</th>
                                <th>Trust Level</th>
                                <th>Data Access</th>
                                <th>What They Learn</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>üè† Household</td>
                                <td>Self</td>
                                <td>Own plaintext demand</td>
                                <td>Only their own data</td>
                            </tr>
                            <tr>
                                <td>üèòÔ∏è Other Households</td>
                                <td class="untrusted">Untrusted</td>
                                <td>Nothing</td>
                                <td>Nothing</td>
                            </tr>
                            <tr>
                                <td>‚¨° Coordinator</td>
                                <td class="semi">Honest-but-curious</td>
                                <td>Only ciphertexts E(d·µ¢)</td>
                                <td class="highlight-green">Nothing (no secret key)</td>
                            </tr>
                            <tr>
                                <td>‚ö° Utility Company</td>
                                <td class="trusted">Trusted</td>
                                <td>Decrypted aggregates only</td>
                                <td>Total & average demand</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Security Logs -->
        <div class="panel">
            <h2>üìã Security Audit Log</h2>
            <div class="log-header">
                <span class="log-legend"><span class="dot green"></span> Encrypted Operation</span>
                <span class="log-legend"><span class="dot yellow"></span> Agent Local</span>
                <span class="log-legend"><span class="dot blue"></span> Utility Decryption</span>
                <span class="log-legend"><span class="dot red"></span> Violation</span>
            </div>
            <div id="security-logs" class="security-logs">
                <div class="log-entry placeholder">Logs will appear here...</div>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <p>Privacy-Preserving Smart Grid using Homomorphic Encryption (CKKS/TenSEAL)</p>
            <p>Coordinator never sees plaintext data. Only encrypted aggregates are decrypted by utility.</p>
        </footer>
    </div>

    <script src="dashboard.js"></script>
    <script>
        // Toggle expandable cards
        function toggleExpand(cardId) {
            const card = document.getElementById(cardId);
            card.classList.toggle('expanded');
        }
    </script>
</body>

</html>